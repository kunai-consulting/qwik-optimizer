---
phase: 11-research-code-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - optimizer/src/transform.rs
  - optimizer/src/transform_tests.rs
autonomous: true

must_haves:
  truths:
    - "transform.rs contains only production code (no #[cfg(test)])"
    - "All 233 tests still pass"
    - "Test code is in a dedicated test file"
  artifacts:
    - path: "optimizer/src/transform_tests.rs"
      provides: "All transform tests (~4500 lines)"
      contains: "#[cfg(test)]"
    - path: "optimizer/src/transform.rs"
      provides: "Production transform code only"
      max_lines: 3500
  key_links:
    - from: "optimizer/src/transform_tests.rs"
      to: "optimizer/src/transform.rs"
      via: "mod transform; use transform::*"
      pattern: "use (super|crate)::transform"
---

<objective>
Move all test code from transform.rs to a dedicated transform_tests.rs file.

Purpose: Immediately reduce transform.rs by ~60% (4500 lines) without changing any production logic. This is the highest-impact first step that makes subsequent refactoring manageable.

Output: transform_tests.rs with all tests, transform.rs with production code only, all 233 tests passing.
</objective>

<execution_context>
@/Users/jackshelton/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jackshelton/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-research-code-cleanup/11-RESEARCH.md

# Source file to split
@optimizer/src/transform.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract tests to transform_tests.rs</name>
  <files>optimizer/src/transform.rs, optimizer/src/transform_tests.rs</files>
  <action>
1. Read transform.rs and identify the test module boundary (starts at line 3068 with `#[cfg(test)]`)

2. Create optimizer/src/transform_tests.rs containing:
   - The entire `#[cfg(test)]` module and all its contents
   - Necessary imports at the top: `use super::*;` or explicit imports for test utilities
   - All test helper functions, test fixtures, and #[test] functions

3. In transform.rs:
   - Remove the entire `#[cfg(test)]` module (lines 3068 to end)
   - Keep all production code unchanged
   - The file should now end where the test module began

4. Update optimizer/src/lib.rs to include the test module:
   - Add `#[cfg(test)] mod transform_tests;` if tests need direct module access
   - Or keep tests as integration tests if they only use public API

Do NOT change any production logic. This is purely a file reorganization.
  </action>
  <verify>
Run `cargo test -p optimizer 2>&1 | tail -20` - all 233 tests should pass.
Run `wc -l optimizer/src/transform.rs` - should be under 3500 lines.
  </verify>
  <done>
- transform.rs under 3500 lines
- transform_tests.rs exists with test code
- All 233 tests pass unchanged
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify test organization and fix imports</name>
  <files>optimizer/src/transform_tests.rs, optimizer/src/lib.rs</files>
  <action>
1. Run the full test suite to identify any import or visibility issues

2. Fix any compilation errors by:
   - Adding `pub` visibility to items that tests need access to
   - Adjusting use statements in transform_tests.rs
   - Ensuring test helpers are available

3. Verify the test file structure:
   - Tests should be grouped logically (unit tests, integration tests, snapshot tests)
   - Helper functions should be at the top of the test module
   - Test macros and fixtures should be accessible

4. Run `cargo test -p optimizer` to confirm all tests pass

Do NOT refactor or reorganize test logic - just ensure they compile and pass.
  </action>
  <verify>
Run `cargo test -p optimizer --no-fail-fast 2>&1 | grep -E "^test|passed|failed"` - all tests pass.
Run `cargo clippy -p optimizer -- -D warnings` - no new warnings from the split.
  </verify>
  <done>
- Zero compilation errors
- All 233 tests pass
- No clippy warnings introduced
  </done>
</task>

</tasks>

<verification>
1. Line count: `wc -l optimizer/src/transform.rs` < 3500
2. Tests pass: `cargo test -p optimizer` shows 233 passed
3. No test module in transform.rs: `grep -c "#\[cfg(test)\]" optimizer/src/transform.rs` returns 0
4. Clippy clean: `cargo clippy -p optimizer` passes
</verification>

<success_criteria>
- transform.rs reduced from 7571 to under 3500 lines
- All test code moved to transform_tests.rs
- All 233 existing tests pass without modification
- No changes to production logic
</success_criteria>

<output>
After completion, create `.planning/phases/11-research-code-cleanup/11-01-SUMMARY.md`
</output>
