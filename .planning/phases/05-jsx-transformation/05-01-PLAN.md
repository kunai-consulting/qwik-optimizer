---
phase: 05-jsx-transformation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - optimizer/src/is_const.rs
  - optimizer/src/lib.rs
  - optimizer/src/transform.rs
autonomous: true

must_haves:
  truths:
    - "Static props categorized to const_props with null for varProps"
    - "Dynamic props (function calls, member access) categorized to var_props"
    - "Empty props objects output as null not {}"
  artifacts:
    - path: "optimizer/src/is_const.rs"
      provides: "is_const_expr function for prop constness detection"
      exports: ["is_const_expr"]
    - path: "optimizer/src/transform.rs"
      provides: "Prop categorization using is_const_expr"
      contains: "is_const_expr"
  key_links:
    - from: "optimizer/src/transform.rs"
      to: "optimizer/src/is_const.rs"
      via: "is_const_expr call in exit_jsx_attribute"
      pattern: "is_const_expr\\("
---

<objective>
Implement prop constness detection and output format fixes for JSX transformation.

Purpose: Correctly categorize JSX props as const or var based on SWC logic, and fix output format (null vs empty objects) to match SWC exactly.

Output: is_const.rs module with ConstCollector, updated exit_jsx_element for proper null handling.
</objective>

<execution_context>
@/Users/jackshelton/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jackshelton/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-jsx-transformation/05-RESEARCH.md

# SWC reference for is_const_expr
@qwik-core/src/optimizer/core/src/is_const.rs

# Current OXC implementation
@optimizer/src/transform.rs
@optimizer/src/component/shared.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create is_const.rs module</name>
  <files>optimizer/src/is_const.rs, optimizer/src/lib.rs</files>
  <action>
Create new is_const.rs module porting the SWC ConstCollector logic:

1. Create `is_const_expr` function that:
   - Takes `expr: &Expression`, `global: &GlobalCollect` (imports/exports), `decl_stack: &[Vec<IdPlusType>]`
   - Uses OXC Visit trait to traverse expression
   - Returns false if: CallExpression, MemberExpression, or non-const identifier found
   - Returns true otherwise

2. Create ConstCollector struct with:
   - `is_const: bool` field (starts true)
   - Reference to GlobalCollect for import/export checking
   - Reference to decl_stack for const variable checking

3. Implement Visit for ConstCollector:
   - `visit_call_expression`: Set is_const = false
   - `visit_member_expression`: Set is_const = false
   - `visit_identifier_reference`: Check if import/export/const-var, else is_const = false
   - Do NOT recurse into ArrowFunctionExpression (they're self-contained)

4. Add `pub mod is_const;` to lib.rs

Port from SWC is_const.rs pattern but use OXC types (Expression, IdentifierReference, etc).
Use GlobalCollect import_by_symbol for import lookup.
Check decl_stack for IdentType::Var(true) to find const variables.
  </action>
  <verify>
`cargo build` compiles without errors.
`cargo test` passes existing tests.
  </verify>
  <done>
is_const.rs module exists with is_const_expr function.
Module registered in lib.rs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix props output format (null vs empty object)</name>
  <files>optimizer/src/transform.rs</files>
  <action>
Update exit_jsx_element to output null instead of empty objects for varProps and constProps:

1. In exit_jsx_element, change varProps argument generation:
   - If `jsx.var_props.is_empty()`: Use `expression_null_literal` instead of empty object
   - Else: Use existing `expression_object(node.span(), jsx.var_props)`

2. Same for constProps:
   - If `jsx.const_props.is_empty()`: Use `expression_null_literal`
   - Else: Use existing `expression_object(node.span(), jsx.const_props)`

3. Same pattern in exit_jsx_fragment (if applicable).

Current output: `_jsxSorted("div", {}, {}, [], 1, null)`
Target output: `_jsxSorted("div", null, null, [], 1, null)`

This matches the SWC reference snapshots exactly.
  </action>
  <verify>
`cargo test` - check existing snapshot tests for updated output format.
Output should show `null` instead of `{}` for empty props.
  </verify>
  <done>
Empty varProps renders as `null` not `{}`.
Empty constProps renders as `null` not `{}`.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire is_const_expr into prop categorization</name>
  <files>optimizer/src/transform.rs</files>
  <action>
Integrate is_const_expr into exit_jsx_attribute for proper prop categorization:

1. Import is_const module in transform.rs

2. In exit_jsx_attribute, when categorizing non-event-handler props:
   - Get the attribute value expression
   - Call `is_const_expr(&expr, &global_collect, &self.decl_stack)`
   - If true AND not should_runtime_sort: Add to const_props
   - Else: Add to var_props

3. Need GlobalCollect access - may need to:
   - Store GlobalCollect reference in TransformGenerator
   - Or pass import_by_symbol/export info through context

4. Keep existing logic for:
   - Event handlers (always var_props due to QRL wrapping)
   - Spread attributes (trigger should_runtime_sort)
   - key prop extraction

Note: The existing expr_is_const_stack approach is simpler but less accurate.
For now, integrate is_const_expr for attribute values at the point of prop categorization.
  </action>
  <verify>
`cargo test` - all tests pass.
Add test case: `<div class="static" data={fn()} />` should put class in const_props, data in var_props.
  </verify>
  <done>
Props correctly categorized based on is_const_expr analysis.
Static string/literal props go to const_props.
Dynamic props (function calls, member access) go to var_props.
  </done>
</task>

</tasks>

<verification>
1. `cargo build` - no compilation errors
2. `cargo test` - all existing tests pass
3. Manual inspection of snapshot output shows null for empty props
4. Test case with mixed static/dynamic props categorizes correctly
</verification>

<success_criteria>
- is_const.rs module created with is_const_expr function
- Empty varProps/constProps output as null
- Props categorization uses is_const_expr for accuracy
- All 115+ existing tests continue passing
</success_criteria>

<output>
After completion, create `.planning/phases/05-jsx-transformation/05-01-SUMMARY.md`
</output>
