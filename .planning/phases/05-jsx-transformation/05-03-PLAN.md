---
phase: 05-jsx-transformation
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - optimizer/src/transform.rs
  - optimizer/src/component/shared.rs
autonomous: true

must_haves:
  truths:
    - "Spread props use _getVarProps(x) and _getConstProps(x) helper calls"
    - "Props after spread go to var_props via _jsxSplit"
    - "Single child passed directly without array wrapper"
  artifacts:
    - path: "optimizer/src/component/shared.rs"
      provides: "_GET_VAR_PROPS and _GET_CONST_PROPS constants"
      contains: "_getVarProps"
    - path: "optimizer/src/transform.rs"
      provides: "Spread props with helper calls and single child optimization"
      contains: "_getVarProps"
  key_links:
    - from: "optimizer/src/transform.rs"
      to: "exit_jsx_spread_attribute"
      via: "spread detection triggers _jsxSplit"
      pattern: "_getVarProps|_getConstProps"
---

<objective>
Implement spread props helpers (_getVarProps/_getConstProps) and single child optimization.

Purpose: Spread props need runtime helpers to extract var/const props. Children should not be wrapped in array when there's only one.

Output: Spread props generate _getVarProps/getConstProps calls, single children output directly.
</objective>

<execution_context>
@/Users/jackshelton/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jackshelton/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-jsx-transformation/05-RESEARCH.md

# SWC reference showing spread output
@qwik-core/src/optimizer/core/src/snapshots/qwik_core__test__example_jsx.snap
@qwik-core/src/optimizer/core/src/snapshots/qwik_core__test__example_spread_jsx.snap

# Current implementation
@optimizer/src/transform.rs
@optimizer/src/component/shared.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add spread prop helper constants</name>
  <files>optimizer/src/component/shared.rs</files>
  <action>
Add constants for spread prop helpers:

```rust
/// Import for _getVarProps helper (spread props runtime)
pub const _GET_VAR_PROPS: &str = "_getVarProps";

/// Import for _getConstProps helper (spread props runtime)
pub const _GET_CONST_PROPS: &str = "_getConstProps";
```

These are used when spread props exist:
```javascript
_jsxSplit("button", { ..._getVarProps(props) }, _getConstProps(props), null, 0, null)
```
  </action>
  <verify>
`cargo build` compiles without errors.
  </verify>
  <done>
_GET_VAR_PROPS and _GET_CONST_PROPS constants defined.
  </done>
</task>

<task type="auto">
  <name>Task 2: Generate _getVarProps/_getConstProps for spread props</name>
  <files>optimizer/src/transform.rs</files>
  <action>
Update exit_jsx_spread_attribute to generate proper helper calls:

1. When encountering spread attribute `{...props}`:
   - Instead of `{ ...props }` in var_props
   - Generate `{ ..._getVarProps(props) }` for var_props
   - Set constProps to `_getConstProps(props)` call expression

2. Update exit_jsx_element for spread case:
   - When should_runtime_sort is true (spread exists):
   - varProps: Object with spread of `_getVarProps(spread_expr)`
   - constProps: Direct call to `_getConstProps(spread_expr)`

3. Store spread expression in JsxState for use in exit_jsx_element:
   - Add `spread_expr: Option<Expression<'gen>>` to JsxState
   - Set in exit_jsx_spread_attribute
   - Use in exit_jsx_element when generating constProps

4. Add imports for _getVarProps and _getConstProps when used.

Reference SWC output:
```javascript
_jsxSplit("button", {
    ..._getVarProps(props)
}, _getConstProps(props), null, 0, null)
```

Note the asymmetry:
- varProps is an object with spread: `{ ..._getVarProps(x) }`
- constProps is the call directly: `_getConstProps(x)`
  </action>
  <verify>
`cargo test` - spread prop tests should match SWC output.
  </verify>
  <done>
Spread props generate _getVarProps/_getConstProps helper calls.
Imports added for helpers when used.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement single child optimization</name>
  <files>optimizer/src/transform.rs</files>
  <action>
Update exit_jsx_element to not wrap single children in array:

1. In children argument generation:
   - If `jsx.children.is_empty()`: Use `expression_null_literal`
   - If `jsx.children.len() == 1`: Extract single child, use directly (not in array)
   - Else: Use `expression_array(node.span(), jsx.children)`

2. Important edge cases:
   - Single text child: `"Hello"` not `["Hello"]`
   - Single element child: `_jsxSorted(...)` not `[_jsxSorted(...)]`
   - Single expression child: `expr` not `[expr]`

3. But keep array for dynamic single child with other children context.

Reference SWC output:
```javascript
// Single child (not array)
_jsxSorted("div", null, { class: "class" }, "12", 3, null)

// Multiple children (array)
_jsxSorted("div", null, null, [child1, child2], 1, null)

// No children (null)
_jsxSorted("div", null, null, null, 3, null)
```

4. Handle conversion from ArrayExpressionElement to Expression for single child:
   - ArrayExpressionElement::SpreadElement -> wrap appropriately
   - ArrayExpressionElement::Elision -> null
   - ArrayExpressionElement::Expression -> unwrap directly
  </action>
  <verify>
`cargo test` - snapshot output shows single children without array wrapper.
  </verify>
  <done>
Empty children output as null.
Single child output directly without array.
Multiple children output as array.
  </done>
</task>

</tasks>

<verification>
1. `cargo build` - no compilation errors
2. `cargo test` - all tests pass
3. Spread props output: `{ ..._getVarProps(x) }, _getConstProps(x)`
4. Single child not wrapped: `"text"` instead of `["text"]`
5. Empty children: `null` instead of `[]`
</verification>

<success_criteria>
- Spread props use _getVarProps/_getConstProps helpers
- Single children passed directly without array wrapper
- Empty children output as null
- All 115+ tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-jsx-transformation/05-03-SUMMARY.md`
</output>
