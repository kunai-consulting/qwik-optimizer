---
phase: 05-jsx-transformation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - optimizer/src/transform.rs
  - optimizer/src/component/shared.rs
autonomous: true

must_haves:
  truths:
    - "Implicit fragments <></> transform to _jsxSorted(_Fragment, ...)"
    - "_Fragment imported from @qwik.dev/core/jsx-runtime"
    - "Explicit Fragment component uses imported Fragment identifier"
  artifacts:
    - path: "optimizer/src/component/shared.rs"
      provides: "_FRAGMENT constant and JSX_RUNTIME_SOURCE"
      contains: "_FRAGMENT"
    - path: "optimizer/src/transform.rs"
      provides: "Fragment transformation in exit_jsx_fragment"
      contains: "_Fragment"
  key_links:
    - from: "optimizer/src/transform.rs"
      to: "optimizer/src/component/shared.rs"
      via: "constant import"
      pattern: "_FRAGMENT|JSX_RUNTIME_SOURCE"
---

<objective>
Implement proper Fragment handling for implicit (<></>) and explicit (<Fragment>) JSX fragments.

Purpose: Currently exit_jsx_fragment outputs a plain array. SWC outputs _jsxSorted(_Fragment, null, null, children, flags, key) with proper import.

Output: Fragment transformation matching SWC exactly with proper imports.
</objective>

<execution_context>
@/Users/jackshelton/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jackshelton/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-jsx-transformation/05-RESEARCH.md

# SWC reference snapshots showing fragment output
@qwik-core/src/optimizer/core/src/snapshots/qwik_core__test__example_jsx.snap
@qwik-core/src/optimizer/core/src/snapshots/qwik_core__test__example_mutable_children.snap

# Current implementation
@optimizer/src/transform.rs
@optimizer/src/component/shared.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Fragment constants</name>
  <files>optimizer/src/component/shared.rs</files>
  <action>
Add constants for Fragment handling:

```rust
/// Import source for jsx-runtime (Fragment import)
pub const JSX_RUNTIME_SOURCE: &str = "@qwik.dev/core/jsx-runtime";

/// Fragment identifier for implicit fragments (<></>)
pub const _FRAGMENT: &str = "_Fragment";
```

These match the SWC output:
- `import { Fragment as _Fragment } from "@qwik.dev/core/jsx-runtime";`
  </action>
  <verify>
`cargo build` compiles without errors.
  </verify>
  <done>
JSX_RUNTIME_SOURCE and _FRAGMENT constants defined in shared.rs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Transform implicit fragments to _jsxSorted(_Fragment, ...)</name>
  <files>optimizer/src/transform.rs</files>
  <action>
Update exit_jsx_fragment to generate proper _jsxSorted call:

1. Import new constants from shared.rs

2. Replace current exit_jsx_fragment logic:
   ```rust
   // Current (outputs array):
   self.replace_expr = Some(self.builder.expression_array(node.span(), jsx.children));

   // New (outputs _jsxSorted call):
   ```

3. Generate _jsxSorted(_Fragment, null, null, children, flags, key):
   - First arg: `_Fragment` identifier reference (not string literal)
   - Second arg: null (no var_props for fragments)
   - Third arg: null (no const_props for fragments)
   - Fourth arg: children array OR single child OR null
   - Fifth arg: flags (use jsx.static_subtree/static_listeners)
   - Sixth arg: key (generate like elements do, or null)

4. Add import for Fragment:
   ```rust
   Import::new(
       vec![ImportId::NamedWithAlias("Fragment".to_string(), "_Fragment".to_string())],
       JSX_RUNTIME_SOURCE
   )
   ```

5. Add import for JSX_SORTED_NAME (fragments use _jsxSorted, not _jsxSplit)

Reference SWC output:
```javascript
import { Fragment as _Fragment } from "@qwik.dev/core/jsx-runtime";
_jsxSorted(_Fragment, null, null, [child1, child2], 1, "u6_0")
```
  </action>
  <verify>
`cargo test` - existing fragment tests should update.
Check snapshot output matches SWC format.
  </verify>
  <done>
Implicit fragments (<></>) output _jsxSorted(_Fragment, null, null, children, flags, key).
Fragment as _Fragment import added from jsx-runtime.
  </done>
</task>

<task type="auto">
  <name>Task 3: Handle explicit Fragment component</name>
  <files>optimizer/src/transform.rs</files>
  <action>
Ensure explicit `<Fragment>` component uses the user-imported Fragment:

1. In exit_jsx_element, when JSXElementName is IdentifierReference:
   - If name is "Fragment": Use the identifier reference directly (user imported it)
   - This already works via the existing code path

2. The distinction:
   - `<></>` (JSXFragment) -> `_jsxSorted(_Fragment, ...)` with jsx-runtime import
   - `<Fragment>` (JSXElement with IdentifierReference) -> `_jsxSorted(Fragment, ...)` using user's import

3. Add test to verify both cases work:
   - Implicit: `<><div/></>` -> uses `_Fragment` from jsx-runtime
   - Explicit: `<Fragment><div/></Fragment>` -> uses user-imported `Fragment`

Reference from SWC snapshot:
```javascript
// Implicit
import { Fragment as _Fragment } from "@qwik.dev/core/jsx-runtime";
_jsxSorted(_Fragment, null, null, child, 3, "u6_26")

// Explicit (user imported Fragment from @qwik.dev/core)
_jsxSorted(Fragment, null, null, child, 1, "u6_25")
```
  </action>
  <verify>
`cargo test` - both implicit and explicit fragment tests pass.
Snapshot shows different Fragment identifiers for each case.
  </verify>
  <done>
Implicit fragments use _Fragment from jsx-runtime.
Explicit Fragment uses user-imported Fragment identifier.
Both output correct _jsxSorted calls.
  </done>
</task>

</tasks>

<verification>
1. `cargo build` - no compilation errors
2. `cargo test` - all tests pass
3. Snapshot for fragment test shows:
   - `import { Fragment as _Fragment } from "@qwik.dev/core/jsx-runtime"`
   - `_jsxSorted(_Fragment, null, null, children, flags, key)`
</verification>

<success_criteria>
- Implicit fragments (<></>) transform to _jsxSorted(_Fragment, ...)
- _Fragment imported from @qwik.dev/core/jsx-runtime
- Explicit Fragment components use user-imported identifier
- Keys generated for fragments inside components
</success_criteria>

<output>
After completion, create `.planning/phases/05-jsx-transformation/05-02-SUMMARY.md`
</output>
