---
phase: 05-jsx-transformation
plan: 04
type: execute
wave: 2
depends_on: ["05-01", "05-02"]
files_modified:
  - optimizer/src/transform.rs
  - optimizer/tests/jsx_tests.rs
autonomous: true

must_haves:
  truths:
    - "Conditional rendering (ternary) preserves both branches"
    - "List rendering (.map) children handled correctly"
    - "Text nodes trimmed and empty ones skipped"
    - "Flags calculation matches SWC (static_subtree, static_listeners)"
  artifacts:
    - path: "optimizer/src/transform.rs"
      provides: "Complete JSX child handling and flags calculation"
      contains: "exit_jsx_child"
    - path: "optimizer/tests/jsx_tests.rs"
      provides: "JSX transformation tests"
      min_lines: 50
  key_links:
    - from: "optimizer/src/transform.rs"
      to: "exit_jsx_child"
      via: "child processing for ternary and map"
      pattern: "exit_jsx_child"
---

<objective>
Complete JSX transformation with conditional rendering, list rendering, and flags calculation.

Purpose: Ensure ternary expressions, .map() calls, and text nodes handle correctly. Verify flags match SWC output.

Output: Complete JSX transformation passing all JSX-related test patterns.
</objective>

<execution_context>
@/Users/jackshelton/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jackshelton/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-jsx-transformation/05-RESEARCH.md

# SWC reference showing conditional/list output
@qwik-core/src/optimizer/core/src/snapshots/qwik_core__test__example_mutable_children.snap

# Current implementation
@optimizer/src/transform.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix flags calculation</name>
  <files>optimizer/src/transform.rs</files>
  <action>
Verify and fix flags calculation to match SWC exactly:

1. Current flags calculation in exit_jsx_element:
   ```rust
   ((if jsx.static_subtree { 0b1 } else { 0 })
    | (if jsx.static_listeners { 0b10 } else { 0 }))
   ```

2. Verify the bit positions match SWC:
   - Bit 0 (value 1): static_subtree
   - Bit 1 (value 2): static_listeners
   - Combined: 3 = both static, 1 = subtree only, 0 = neither

3. Verify static_subtree and static_listeners are set correctly:
   - static_subtree = false when: dynamic children, spread props, non-const props
   - static_listeners = false when: event handler props (onClick$, etc.)

4. Currently JsxState initializes both to true. They should be set to false when:
   - exit_jsx_spread_attribute: both become false
   - exit_jsx_attribute with event handler: static_listeners = false
   - exit_jsx_child with dynamic content: static_subtree = false

5. Check existing flag-setting code and add any missing cases.
  </action>
  <verify>
`cargo test` - check snapshot flags match SWC reference.
  </verify>
  <done>
Flags values match SWC output (3 for static, 1 for dynamic subtree, 0 for dynamic listeners).
  </done>
</task>

<task type="auto">
  <name>Task 2: Handle conditional and list rendering in children</name>
  <files>optimizer/src/transform.rs</files>
  <action>
Ensure conditional (ternary) and list (.map) expressions pass through correctly:

1. In exit_jsx_child for JSXChild::ExpressionContainer:
   - Ternary expressions: Both branches should be preserved as-is
   - The nested JSX in each branch transforms via exit_jsx_element
   - Result should be the ternary with transformed JSX in branches

2. For .map() expressions:
   - The mapped JSX elements transform individually
   - The map call expression stays as the child
   - Keys should be generated for mapped elements

3. Verify replace_expr mechanism works for nested JSX:
   - When exit_jsx_element sets replace_expr, exit_expression picks it up
   - This should handle JSX inside ternary branches

4. Check that conditional children set static_subtree = false:
   - Ternary expressions are dynamic
   - Map expressions are dynamic
   - Add check in exit_jsx_child for these cases

Reference SWC output:
```javascript
// Ternary
_jsxSorted("div", null, null,
  prop < 2 ? _jsxSorted("p", ...) : _jsxSorted(Stuff, ...),
  1, null)

// Map
head.meta.map((m) => _jsxSplit("meta", {..._getVarProps(m)}, _getConstProps(m), null, 0, "u6_0"))
```
  </action>
  <verify>
`cargo test` - conditional and map expressions in JSX output correctly.
  </verify>
  <done>
Ternary expressions preserve both branches with transformed JSX.
Map expressions output with transformed JSX callbacks.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add comprehensive JSX transformation tests</name>
  <files>optimizer/tests/jsx_tests.rs</files>
  <action>
Create comprehensive test file for JSX transformation:

1. Create optimizer/tests/jsx_tests.rs with test cases:

```rust
// Test 1: Basic element with static props
// Input: <div class="foo" />
// Expected: _jsxSorted("div", null, { class: "foo" }, null, 3, null)

// Test 2: Element with dynamic props
// Input: <div class={getClass()} />
// Expected: _jsxSorted("div", { class: getClass() }, null, null, 1, null)

// Test 3: Implicit fragment
// Input: <><div /><span /></>
// Expected: _jsxSorted(_Fragment, null, null, [...], 1, "key")

// Test 4: Single child (no array)
// Input: <div>hello</div>
// Expected: _jsxSorted("div", null, null, "hello", 3, null)

// Test 5: Spread props
// Input: <button {...props} />
// Expected: _jsxSplit("button", { ..._getVarProps(props) }, _getConstProps(props), null, 0, null)

// Test 6: Conditional child
// Input: <div>{cond ? <a/> : <b/>}</div>
// Expected: _jsxSorted("div", null, null, cond ? _jsxSorted("a"...) : _jsxSorted("b"...), 1, null)

// Test 7: List child
// Input: <ul>{items.map(i => <li key={i}/>)}</ul>
// Expected: _jsxSorted("ul", null, null, items.map(...), 1, null)
```

2. Use existing test infrastructure (transform_modules, snapshot assertions).

3. Each test should verify:
   - Correct function call (_jsxSorted vs _jsxSplit)
   - Correct prop categorization
   - Correct children format
   - Correct flags value
  </action>
  <verify>
`cargo test jsx_tests` - all new tests pass.
Snapshot output matches expected patterns.
  </verify>
  <done>
Comprehensive JSX test suite covering all JSX-0X requirements.
Tests verify output matches SWC reference format.
  </done>
</task>

</tasks>

<verification>
1. `cargo build` - no compilation errors
2. `cargo test` - all tests pass including new jsx_tests
3. Flags match SWC: 3 for static, 1 for dynamic subtree, 0 for both dynamic
4. Ternary and map children work correctly
5. Test coverage for all JSX-01 through JSX-08 requirements
</verification>

<success_criteria>
- Flags calculation matches SWC exactly
- Conditional rendering (ternary) works in children
- List rendering (.map) works in children
- Comprehensive test coverage for JSX patterns
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-jsx-transformation/05-04-SUMMARY.md`
</output>
