---
phase: 06-imports-exports
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - optimizer/src/component/qrl.rs
  - optimizer/src/code_move.rs
  - optimizer/src/transform.rs
autonomous: true

must_haves:
  truths:
    - "Segment files import exports from source file via relative path"
    - "Aliased exports use correct import name (expr2 as internal)"
    - "Default exports import with correct syntax"
  artifacts:
    - path: "optimizer/src/code_move.rs"
      provides: "Segment file import generation"
      contains: "generate_segment_imports"
    - path: "optimizer/src/component/qrl.rs"
      provides: "QRL with export reference tracking"
      contains: "referenced_exports"
  key_links:
    - from: "optimizer/src/code_move.rs"
      to: "optimizer/src/transform.rs"
      via: "export_by_name lookup"
      pattern: "export_by_name\\.get"
---

<objective>
Implement segment file import generation from source exports.

Purpose: When a QRL segment references a symbol exported from the source file (like `Footer` in example_exports.snap), the segment file must import it: `import { Footer } from "./test"`. This requires:
1. Tracking which identifiers in QRL body are source exports
2. Generating correct import statements with aliases

Output: Segment files with proper imports from source file for referenced exports.
</objective>

<execution_context>
@/Users/jackshelton/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jackshelton/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-imports-exports/06-RESEARCH.md
@.planning/phases/06-imports-exports/06-01-SUMMARY.md
@optimizer/src/code_move.rs
@optimizer/src/component/qrl.rs
@optimizer/src/transform.rs
@qwik-core/src/optimizer/core/src/snapshots/qwik_core__test__example_exports.snap
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add referenced_exports to Qrl struct</name>
  <files>optimizer/src/component/qrl.rs</files>
  <action>
Extend Qrl struct to track exports referenced in QRL body:

1. Add field `referenced_exports: Vec<ExportInfo>` to Qrl struct (or Vec<(String, String, bool)> for simpler approach: local_name, exported_name, is_default)

2. Update Qrl::new() to accept and store referenced exports

3. The exports are determined during QRL extraction by checking:
   - For each identifier in the QRL body
   - If not in import_by_symbol (third-party import)
   - If not in scoped_idents (captured local variable)
   - If in export_by_name (source file export)
   - Then it's a referenced export

4. This list will be used by code_move.rs to generate segment file imports

Reference SWC pattern from code_move.rs:58-99 which iterates ctx.local_idents and checks ctx.global.exports.
  </action>
  <verify>`cargo build -p qwik-optimizer` compiles</verify>
  <done>Qrl struct has referenced_exports field for tracking source file exports used in QRL</done>
</task>

<task type="auto">
  <name>Task 2: Populate referenced_exports during QRL creation</name>
  <files>optimizer/src/transform.rs</files>
  <action>
When creating a Qrl, determine which identifiers are source exports:

1. In exit_call_expression (around line 842-930) where QRL is created:
   - After collecting descendent_idents via IdentCollector
   - After filtering to get scoped_idents
   - Add: collect referenced exports

2. For each identifier in descendent_idents:
   ```rust
   let mut referenced_exports = Vec::new();
   for ident in &descendent_idents {
       let name = &ident.0;
       // Skip if it's an import
       if imported_names.contains(name) { continue; }
       // Skip if it's a captured variable (scoped_ident)
       if scoped_idents.iter().any(|s| &s.0 == name) { continue; }
       // Check if it's an export
       if let Some(export_info) = self.export_by_name.get(name) {
           referenced_exports.push(export_info.clone());
       }
   }
   ```

3. Pass referenced_exports to Qrl constructor

4. Apply same logic in exit_jsx_attribute_value where event handler QRLs are created (around line 1633-1808)
  </action>
  <verify>`cargo build -p qwik-optimizer` compiles</verify>
  <done>QRL creation populates referenced_exports with source file exports used in QRL body</done>
</task>

<task type="auto">
  <name>Task 3: Generate segment file imports from exports</name>
  <files>optimizer/src/code_move.rs</files>
  <action>
Update code_move.rs to generate imports for referenced exports:

1. The existing `new_module` function (or equivalent) generates segment file content

2. Add import generation for referenced_exports:
   ```rust
   for export_info in &qrl.referenced_exports {
       // Generate: import { exported_name as local_name } from "./source-file"
       // Or for default: import { default as local_name } from "./source-file"

       let import_name = if export_info.is_default {
           ImportId::NamedWithAlias("default".to_string(), export_info.local_name.clone())
       } else if export_info.exported_name != export_info.local_name {
           // Aliased export: export { internal as expr2 }
           // Import as: import { expr2 as internal } from "./source"
           ImportId::NamedWithAlias(export_info.exported_name.clone(), export_info.local_name.clone())
       } else {
           ImportId::Named(export_info.local_name.clone())
       };

       let import = Import::new(vec![import_name], source_file_path);
       // Add to segment file imports
   }
   ```

3. The source_file_path should be relative like "./test" (derived from source_info)

4. Ensure imports are sorted/deduplicated for deterministic output

Reference expected output from example_exports.snap lines 84-95:
```
import { default as DefaultFn } from "./test";
import { Footer } from "./test";
import { a } from "./test";
...
```
  </action>
  <verify>`cargo test` passes, segment files have correct imports from source</verify>
  <done>Segment files import referenced exports from source file with correct syntax</done>
</task>

</tasks>

<verification>
1. `cargo build -p qwik-optimizer` compiles
2. `cargo test -p qwik-optimizer` passes
3. Segment files include imports from source file for referenced exports
4. Aliased exports import with correct names
5. Default exports import with `default as Name` syntax
</verification>

<success_criteria>
- referenced_exports field populated during QRL creation
- code_move.rs generates import statements from source file
- Import names match export names (handling aliases)
- Default exports handled correctly
- Output matches SWC reference (example_exports.snap)
</success_criteria>

<output>
After completion, create `.planning/phases/06-imports-exports/06-03-SUMMARY.md`
</output>
