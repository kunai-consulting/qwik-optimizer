---
phase: 06-imports-exports
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - optimizer/src/transform.rs
  - optimizer/src/collector.rs
autonomous: true

must_haves:
  truths:
    - "Exports from source file are tracked for segment file import generation"
    - "Segment files import exported symbols from source file correctly"
  artifacts:
    - path: "optimizer/src/collector.rs"
      provides: "GlobalCollect-like export tracking"
      contains: "export_by_name"
    - path: "optimizer/src/transform.rs"
      provides: "Export tracking integration"
      contains: "export_by_name"
  key_links:
    - from: "optimizer/src/transform.rs"
      to: "optimizer/src/collector.rs"
      via: "export_by_name HashMap"
      pattern: "export_by_name"
---

<objective>
Implement export tracking for segment file import generation.

Purpose: When QRL segment files reference symbols that are exports from the source file (like `Footer`, `a`, `b` in example_exports.snap), those segments need to import from `"./test"` (the source file). This requires tracking which identifiers are exports vs local-only.

Output: `export_by_name` HashMap tracking all module exports for segment import resolution.
</objective>

<execution_context>
@/Users/jackshelton/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jackshelton/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-imports-exports/06-RESEARCH.md
@optimizer/src/collector.rs
@optimizer/src/transform.rs
@optimizer/src/component/shared.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add export tracking to collector.rs</name>
  <files>optimizer/src/collector.rs</files>
  <action>
Add an `ExportInfo` struct and export collection to the collector module:

1. Define `ExportInfo` struct with fields:
   - `local_name: String` - the local identifier name
   - `exported_name: String` - the exported name (may differ for `export { x as y }`)
   - `is_default: bool` - true for default exports

2. Add `collect_exports` function that visits the AST and collects:
   - Named exports with declarations: `export const Foo = ...`
   - Named export lists: `export { foo, bar as baz }`
   - Default exports: `export default function ...`
   - Re-exports: `export { foo } from './other'` (store source path)

Reference SWC patterns from collector.rs:203-292 in qwik-core.

The function should return `HashMap<String, ExportInfo>` keyed by local name.
  </action>
  <verify>`cargo build -p qwik-optimizer` compiles without errors</verify>
  <done>ExportInfo struct and collect_exports function exist in collector.rs</done>
</task>

<task type="auto">
  <name>Task 2: Integrate export tracking into TransformGenerator</name>
  <files>optimizer/src/transform.rs</files>
  <action>
Add export tracking to TransformGenerator:

1. Add field `export_by_name: HashMap<String, ExportInfo>` to TransformGenerator struct

2. In the `new()` constructor, initialize as empty HashMap

3. Add `enter_export_named_declaration` to populate `export_by_name`:
   - For `export const x = ...`: add (x, ExportInfo { local_name: x, exported_name: x, is_default: false })
   - For `export { x, y as z }`: add entries with potentially different exported names
   - For `export function foo() {}` and `export class Bar {}`: add entries

4. Add `enter_export_default_declaration`:
   - For `export default function Name() {}`: add with is_default: true
   - For anonymous: use synthetic name like "_default"

5. The Qrl struct already has `scoped_idents`. When generating segment file imports, check:
   - If identifier is in `import_by_symbol`: import from original source
   - If identifier is in `export_by_name`: import from source file (e.g., "./test")

Do NOT call collect_exports here - use the enter_ hooks for incremental tracking.
  </action>
  <verify>`cargo test` passes, exports are tracked during traversal</verify>
  <done>TransformGenerator tracks exports via enter_export_* hooks, export_by_name HashMap populated</done>
</task>

<task type="auto">
  <name>Task 3: Add test for export tracking</name>
  <files>optimizer/src/transform.rs</files>
  <action>
Add a test case that verifies export tracking works correctly.

Create test `test_export_tracking`:
```rust
#[test]
fn test_export_tracking() {
    let source = r#"
        import { component$ } from '@qwik.dev/core';

        export const foo = 1;
        export function bar() {}
        export class Baz {}
        export { foo as renamed };
        export default function DefaultFn() {}
    "#;

    // Parse and transform, verify export_by_name contains:
    // - foo (named)
    // - bar (named, function)
    // - Baz (named, class)
    // - renamed (aliased from foo)
    // - DefaultFn (default)
}
```

Focus on verifying the tracking mechanism works - the actual segment import generation is plan 03.
  </action>
  <verify>`cargo test test_export_tracking` passes</verify>
  <done>Test confirms export tracking captures named, default, and aliased exports</done>
</task>

</tasks>

<verification>
1. `cargo build -p qwik-optimizer` compiles
2. `cargo test -p qwik-optimizer` passes
3. ExportInfo struct exists with local_name, exported_name, is_default fields
4. export_by_name HashMap populated during AST traversal
</verification>

<success_criteria>
- Export declarations (named, default, aliased) are tracked in export_by_name
- Tracking integrates with existing TransformGenerator without breaking current tests
- Foundation ready for segment file import generation (plan 03)
</success_criteria>

<output>
After completion, create `.planning/phases/06-imports-exports/06-01-SUMMARY.md`
</output>
