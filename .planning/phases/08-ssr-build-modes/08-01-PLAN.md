---
phase: 08-ssr-build-modes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - optimizer/src/transform.rs
  - optimizer/src/component/shared.rs
  - optimizer/src/lib.rs
autonomous: true

must_haves:
  truths:
    - "TransformOptions has is_server field with default true"
    - "TransformOptions has is_dev field derived from target"
    - "QWIK_CORE_BUILD constant available for import tracking"
    - "IS_SERVER, IS_BROWSER, IS_DEV identifier constants defined"
    - "get_imported_local method finds imported identifiers by source and specifier"
  artifacts:
    - path: "optimizer/src/transform.rs"
      provides: "TransformOptions with is_server and is_dev fields"
      contains: "is_server: bool"
    - path: "optimizer/src/component/shared.rs"
      provides: "Build constants for SSR/build mode identifiers"
      contains: "QWIK_CORE_BUILD"
  key_links:
    - from: "optimizer/src/transform.rs"
      to: "optimizer/src/component/shared.rs"
      via: "use of QWIK_CORE_BUILD constant"
      pattern: "QWIK_CORE_BUILD"
---

<objective>
Add TransformOptions fields and import tracking infrastructure for SSR/build mode const replacement.

Purpose: Provides the foundation for the const replacement visitor - configuration fields and import tracking needed to identify which identifiers to replace.

Output: Extended TransformOptions with is_server/is_dev fields, new build constants, and get_imported_local helper method.
</objective>

<execution_context>
@/Users/jackshelton/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jackshelton/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-ssr-build-modes/08-RESEARCH.md

# Source files to modify
@optimizer/src/transform.rs
@optimizer/src/component/shared.rs
@optimizer/src/import_clean_up.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add build mode constants to shared.rs</name>
  <files>optimizer/src/component/shared.rs</files>
  <action>
Add the following constants to component/shared.rs for SSR/build mode support:

```rust
/// Import source for build mode constants (isServer, isBrowser, isDev)
pub const QWIK_CORE_BUILD: &str = "@qwik.dev/core/build";

/// isServer identifier - true on server, false in browser
pub const IS_SERVER: &str = "isServer";

/// isBrowser identifier - inverse of isServer (!isServer)
pub const IS_BROWSER: &str = "isBrowser";

/// isDev identifier - true in development mode
pub const IS_DEV: &str = "isDev";
```

Place these after the existing QWIK_CORE_SOURCE constant. These constants will be used by:
1. The import tracking to find imported isServer/isBrowser/isDev identifiers
2. The const replacer visitor to match identifier names
  </action>
  <verify>Run `cargo build` - should compile without errors</verify>
  <done>QWIK_CORE_BUILD, IS_SERVER, IS_BROWSER, IS_DEV constants exist in shared.rs</done>
</task>

<task type="auto">
  <name>Task 2: Extend TransformOptions with is_server and is_dev</name>
  <files>optimizer/src/transform.rs</files>
  <action>
Extend the TransformOptions struct (around line 2745) to include SSR/build mode configuration:

1. Add new fields to TransformOptions struct:
```rust
pub struct TransformOptions {
    pub minify: bool,
    pub target: Target,
    pub transpile_ts: bool,
    pub transpile_jsx: bool,
    pub entry_strategy: EntryStrategy,
    /// Whether this is a server build (true) or client/browser build (false).
    /// Default: true (safe default - server code is safer to run on server than client code on server)
    pub is_server: bool,
}
```

2. Update Default impl to set is_server to true:
```rust
impl Default for TransformOptions {
    fn default() -> Self {
        TransformOptions {
            minify: false,
            target: Target::Dev,
            transpile_ts: false,
            transpile_jsx: false,
            entry_strategy: EntryStrategy::Segment,
            is_server: true,  // Safe default
        }
    }
}
```

3. Add builder method:
```rust
impl TransformOptions {
    // ... existing methods ...

    pub fn with_is_server(mut self, is_server: bool) -> Self {
        self.is_server = is_server;
        self
    }
}
```

4. Add is_dev() helper method to TransformOptions (derived from target):
```rust
impl TransformOptions {
    /// Returns true if running in development mode (Target::Dev)
    pub fn is_dev(&self) -> bool {
        self.target == Target::Dev
    }
}
```

Note: is_dev is derived from target, not stored separately, matching how the SWC implementation works.
  </action>
  <verify>Run `cargo build` and `cargo test` - all 177 existing tests should pass</verify>
  <done>TransformOptions has is_server field (default true) and is_dev() method</done>
</task>

<task type="auto">
  <name>Task 3: Add get_imported_local helper for import tracking</name>
  <files>optimizer/src/transform.rs</files>
  <action>
Add a helper struct and method to TransformGenerator for tracking imported identifiers by source and specifier.

1. Add an ImportTracker struct near the top of transform.rs (after imports):
```rust
use std::collections::HashMap;

/// Tracks imported identifiers by source module.
/// Maps (source, specifier) -> local_name for finding aliased imports.
#[derive(Debug, Default)]
pub struct ImportTracker {
    /// Maps (source, imported_name) -> local_name
    /// e.g., ("@qwik.dev/core/build", "isServer") -> "s" for `import { isServer as s }`
    imports: HashMap<(String, String), String>,
}

impl ImportTracker {
    pub fn new() -> Self {
        Self::default()
    }

    /// Record an import: import { specifier as local } from 'source'
    pub fn add_import(&mut self, source: &str, specifier: &str, local: &str) {
        self.imports.insert(
            (source.to_string(), specifier.to_string()),
            local.to_string(),
        );
    }

    /// Get the local name for an imported specifier from a source.
    /// Returns None if not imported.
    pub fn get_imported_local(&self, specifier: &str, source: &str) -> Option<&String> {
        self.imports.get(&(source.to_string(), specifier.to_string()))
    }
}
```

2. Add import_tracker field to TransformGenerator struct:
```rust
pub struct TransformGenerator<'a> {
    // ... existing fields ...
    /// Tracks imported identifiers for const replacement
    pub import_tracker: ImportTracker,
}
```

3. Initialize import_tracker in TransformGenerator::new():
```rust
import_tracker: ImportTracker::new(),
```

4. Populate import_tracker in the enter_import_declaration visitor method. Add/update this method:
```rust
fn enter_import_declaration(
    &mut self,
    node: &ImportDeclaration<'a>,
    _ctx: &mut TraverseCtx<'a, ()>,
) {
    let source = node.source.value.to_string();
    // Track imports for const replacement
    if let Some(specifiers) = &node.specifiers {
        for specifier in specifiers {
            match specifier {
                ImportDeclarationSpecifier::ImportSpecifier(spec) => {
                    let imported = spec.imported.name().to_string();
                    let local = spec.local.name.to_string();
                    self.import_tracker.add_import(&source, &imported, &local);
                }
                ImportDeclarationSpecifier::ImportDefaultSpecifier(spec) => {
                    let local = spec.local.name.to_string();
                    self.import_tracker.add_import(&source, "default", &local);
                }
                ImportDeclarationSpecifier::ImportNamespaceSpecifier(spec) => {
                    let local = spec.local.name.to_string();
                    self.import_tracker.add_import(&source, "*", &local);
                }
            }
        }
    }
}
```

This provides the get_imported_local functionality needed by the const replacer to find aliased imports like `import { isServer as s }`.
  </action>
  <verify>Run `cargo test` - all tests should pass. Add a unit test for ImportTracker.</verify>
  <done>ImportTracker struct exists with get_imported_local method, integrated into TransformGenerator</done>
</task>

</tasks>

<verification>
After all tasks:
1. `cargo build` compiles successfully
2. `cargo test` - all 177 existing tests pass
3. Constants IS_SERVER, IS_BROWSER, IS_DEV, QWIK_CORE_BUILD defined in shared.rs
4. TransformOptions has is_server field with default true
5. TransformOptions has is_dev() method returning target == Target::Dev
6. ImportTracker struct tracks imports and provides get_imported_local()
</verification>

<success_criteria>
- QWIK_CORE_BUILD constant = "@qwik.dev/core/build"
- IS_SERVER, IS_BROWSER, IS_DEV constants defined
- TransformOptions.is_server field exists with default true
- TransformOptions.is_dev() method returns true for Target::Dev
- ImportTracker.get_imported_local() finds aliased imports
- All 177 existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/08-ssr-build-modes/08-01-SUMMARY.md`
</output>
