---
phase: 10-edge-cases
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - optimizer/src/transform.rs
autonomous: true

must_haves:
  truths:
    - "Nested map loops pass iteration variables via q:p prop instead of capture"
    - "Inner loop event handlers capture outer loop iteration variables"
    - "QRL references hoisted outside loop bodies"
  artifacts:
    - path: "optimizer/src/transform.rs"
      provides: "loop_depth and iteration_var_stack tracking"
      contains: "loop_depth"
  key_links:
    - from: "enter_call_expression"
      to: "iteration_var_stack"
      via: "map callback detection"
      pattern: "iteration_var_stack\\.push"
---

<objective>
Implement loop tracking infrastructure (loop_depth, iteration_var_stack) for nested loop support in QRL.

Purpose: Event handlers inside map/forEach callbacks need iteration variables passed via `q:p` prop rather than captured, to avoid stale closure bugs where all iterations share the same value.

Output: TransformGenerator tracks loop context and iteration variables for correct QRL hoisting.
</objective>

<execution_context>
@/Users/jackshelton/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jackshelton/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-edge-cases/10-RESEARCH.md
@optimizer/src/transform.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add loop tracking fields to TransformGenerator</name>
  <files>optimizer/src/transform.rs</files>
  <action>
Add two fields to the TransformGenerator struct:

1. `loop_depth: u32` - Tracks nesting depth of loops (for/while/for-in/for-of/map callbacks)
2. `iteration_var_stack: Vec<Vec<Id>>` - Stack of iteration variable names per loop level

Initialize both in `TransformGenerator::new()`:
- `loop_depth: 0`
- `iteration_var_stack: Vec::new()`

The iteration_var_stack stores `Vec<Id>` (same `Id` type used elsewhere: `(String, ScopeId)`) because a single loop level can have multiple iteration variables (e.g., `(v, idx)` in map callback).

Reference SWC pattern from RESEARCH.md lines 38-46.
  </action>
  <verify>Code compiles with `~/.cargo/bin/cargo check --lib`</verify>
  <done>TransformGenerator has loop_depth and iteration_var_stack fields initialized</done>
</task>

<task type="auto">
  <name>Task 2: Add map callback detection in enter/exit_call_expression</name>
  <files>optimizer/src/transform.rs</files>
  <action>
Detect `.map()` callbacks as "loop context" for QRL hoisting:

In `enter_call_expression`:
1. Check if callee is a member expression with property name "map"
2. Check if first argument is a function (arrow or function expression)
3. If yes, increment loop_depth and push iteration variables to iteration_var_stack
4. Extract iteration variables from function parameters (first param is usually the item, second is index)

Pattern to detect:
```rust
if let Expression::CallExpression(call) = &node {
    // Check for .map() pattern
    if let Some(member) = call.callee.as_member_expression() {
        if member.static_property_name() == Some("map") {
            // Check first arg is function
            if let Some(arg) = call.arguments.first() {
                // Extract iteration vars from function params
            }
        }
    }
}
```

In `exit_call_expression`:
1. Pop from iteration_var_stack if we pushed on entry
2. Decrement loop_depth if we incremented on entry

Use a flag or check to avoid double-counting with existing call expression processing.

Reference SWC RESEARCH.md pitfall #2: "Map callbacks not recognized as loop context".
  </action>
  <verify>Tests pass with `~/.cargo/bin/cargo test --lib`</verify>
  <done>Map callback pattern detected and loop_depth tracked</done>
</task>

<task type="auto">
  <name>Task 3: Add test for nested loop iteration variable handling</name>
  <files>optimizer/src/transform.rs</files>
  <action>
Add a test `test_nested_loop_detection` that verifies:

1. Simple `.map()` increments loop_depth
2. Nested `.map()` inside `.map()` increments to 2
3. Iteration variables extracted from map callback params

Test input pattern:
```javascript
import { component$ } from '@qwik.dev/core';
const Foo = component$(() => {
  const data = [];
  return <div>
    {data.map(row => (
      <div onClick$={() => console.log(row)}>
        {data.map(item => (
          <p onClick$={() => console.log(row, item)}></p>
        ))}
      </div>
    ))}
  </div>;
});
```

Verify that:
- Outer handler gets `row` as iteration var (via q:p)
- Inner handler gets `item` as iteration var, captures `row`

Reference expected output from `should_transform_nested_loops.snap` in RESEARCH.md.
  </action>
  <verify>Test passes with `~/.cargo/bin/cargo test test_nested_loop_detection --lib`</verify>
  <done>Nested loop detection test validates iteration variable tracking</done>
</task>

</tasks>

<verification>
1. `~/.cargo/bin/cargo check --lib` - No compilation errors
2. `~/.cargo/bin/cargo test --lib` - All 218+ tests pass
3. New test validates nested loop iteration variable extraction
</verification>

<success_criteria>
- TransformGenerator has loop_depth and iteration_var_stack fields
- Map callback detection increments/decrements loop_depth
- Iteration variables extracted from map callback parameters
- Test validates nested loop pattern detection
</success_criteria>

<output>
After completion, create `.planning/phases/10-edge-cases/10-01-SUMMARY.md`
</output>
