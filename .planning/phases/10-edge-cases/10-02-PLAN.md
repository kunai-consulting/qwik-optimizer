---
phase: 10-edge-cases
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - optimizer/src/transform.rs
autonomous: true

must_haves:
  truths:
    - "Aliased imports (component$ as Component) skip QRL transformation"
    - "Code with skip marker passes through unchanged"
    - "Diagnostics report illegal code but transformation continues"
  artifacts:
    - path: "optimizer/src/transform.rs"
      provides: "Skip transform detection and illegal code diagnostic wiring"
      contains: "C02"
  key_links:
    - from: "illegal_code.rs"
      to: "ProcessingFailure"
      via: "diagnostic output"
      pattern: 'code.*C02'
---

<objective>
Implement skip transform marker detection and wire illegal code detection to diagnostic output.

Purpose:
1. Allow selective skip of QRL transformation when imports are aliased (component$ as Component)
2. Report illegal code (classes/functions in QRL) as diagnostics without failing transformation

Output: Skip transform works and illegal code diagnostics match SWC format.
</objective>

<execution_context>
@/Users/jackshelton/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jackshelton/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-edge-cases/10-RESEARCH.md
@optimizer/src/transform.rs
@optimizer/src/illegal_code.rs
@optimizer/src/processing_failure.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement skip transform detection for aliased imports</name>
  <files>optimizer/src/transform.rs</files>
  <action>
Add skip transform detection for aliased $ marker functions. When `component$` or `$` is imported as a different name, skip QRL transformation.

In the import collection phase:
1. Track when qwik marker functions (component$, $, useTask$, etc.) are imported with aliases
2. Store aliased names in a `skip_transform_names: HashSet<String>` field

Check pattern: When processing a call expression, if the callee name is in `skip_transform_names`, do NOT extract as QRL.

Example from SWC snapshot (example_skip_transform.snap):
```javascript
import { component$ as Component, $ as onRender } from '@qwik.dev/core';
// These should NOT be transformed - just preserve as-is
export const handler = $(()=>console.log('hola'));
export const App = component$((props) => { ... });
```

The key insight: When `$` is aliased (imported as something else), the transformation should be skipped entirely. The output should be the same as input (just with JSX transformed).
  </action>
  <verify>Code compiles with `~/.cargo/bin/cargo check --lib`</verify>
  <done>Aliased $ marker functions tracked for skip transform</done>
</task>

<task type="auto">
  <name>Task 2: Wire illegal code detection to diagnostic output</name>
  <files>optimizer/src/transform.rs, optimizer/src/processing_failure.rs</files>
  <action>
Wire the existing IllegalCodeType detection to produce diagnostics in SWC format.

1. Update ProcessingFailure enum to include full diagnostic fields:
```rust
pub enum ProcessingFailure {
    IllegalCode {
        category: String,  // "error"
        code: String,      // "C02"
        file: String,      // filename
        message: String,   // "Reference to identifier 'X' can not be used..."
        scope: String,     // "optimizer"
    },
}
```

2. In transform.rs, during QRL body analysis (where illegal code might be referenced):
   - Check for references to locally-defined functions or classes
   - When found, create ProcessingFailure with proper format
   - Add to self.errors vector
   - Continue transformation (don't fail)

3. The message format must match SWC exactly:
```
"Reference to identifier '{name}' can not be used inside a Qrl($) scope because it's a {type}"
```

Where `{type}` is "function" or "class".

Reference: RESEARCH.md lines 88-118 and example_capturing_fn_class.snap lines 99-119.
  </action>
  <verify>Code compiles with `~/.cargo/bin/cargo check --lib`</verify>
  <done>Illegal code produces C02 diagnostics in SWC format</done>
</task>

<task type="auto">
  <name>Task 3: Add tests for skip transform and illegal code diagnostics</name>
  <files>optimizer/src/transform.rs</files>
  <action>
Add two tests:

1. `test_skip_transform_aliased_import`:
```javascript
import { component$ as Component, $ as onRender } from '@qwik.dev/core';
export const handler = $(()=>console.log('hola'));
```
Verify: Output preserves original syntax without QRL extraction.

2. `test_illegal_code_diagnostic`:
```javascript
import { $, component$ } from '@qwik.dev/core';
export const App = component$(() => {
  function hola() { console.log('hola'); }
  class Thing {}
  return $(() => {
    hola();
    new Thing();
    return <div></div>;
  });
});
```
Verify:
- Transformation completes (doesn't fail)
- errors vector contains 2 ProcessingFailure entries
- Error codes are "C02"
- Messages reference "hola" and "Thing" with correct type
- Category is "error", scope is "optimizer"

Match format from example_capturing_fn_class.snap DIAGNOSTICS section.
  </action>
  <verify>Tests pass with `~/.cargo/bin/cargo test test_skip_transform --lib && ~/.cargo/bin/cargo test test_illegal_code --lib`</verify>
  <done>Skip transform and illegal code diagnostics have test coverage</done>
</task>

</tasks>

<verification>
1. `~/.cargo/bin/cargo check --lib` - No compilation errors
2. `~/.cargo/bin/cargo test --lib` - All tests pass
3. Skip transform test validates aliased imports preserve original syntax
4. Illegal code test validates diagnostic format matches SWC
</verification>

<success_criteria>
- Aliased $ imports skip QRL transformation
- Illegal code in QRL produces diagnostics but continues transformation
- Diagnostic format matches SWC exactly (category, code, file, message, scope)
- Both behaviors have test coverage
</success_criteria>

<output>
After completion, create `.planning/phases/10-edge-cases/10-02-SUMMARY.md`
</output>
