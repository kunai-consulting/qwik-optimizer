---
phase: 10-edge-cases
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - optimizer/src/transform.rs
autonomous: true

must_haves:
  truths:
    - "Async arrow functions preserve async keyword in output segment"
    - "Async function expressions preserve async keyword"
    - "Await expressions work correctly inside QRL segments"
  artifacts:
    - path: "optimizer/src/transform.rs"
      provides: "Async/await preservation in QRL extraction"
  key_links:
    - from: "QRL extraction"
      to: "segment output"
      via: "async flag preservation"
      pattern: "async.*=>"
---

<objective>
Verify and test async/await preservation in QRL segments.

Purpose: Async functions used with $, useTask$, and component$ must preserve the async keyword when extracted to segment files.

Output: Tests validating async/await works correctly in all QRL contexts.
</objective>

<execution_context>
@/Users/jackshelton/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jackshelton/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-edge-cases/10-RESEARCH.md
@optimizer/src/transform.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add test for async arrow functions in QRL</name>
  <files>optimizer/src/transform.rs</files>
  <action>
Add test `test_async_arrow_qrl` for async arrow functions:

Input:
```javascript
import { $ } from '@qwik.dev/core';

export const fetchData = $(async () => {
  const response = await fetch('/api/data');
  const data = await response.json();
  return data;
});
```

Verify:
- Segment code starts with `async () => {` (async keyword preserved)
- await expressions preserved inside function body
- No transformation errors

Check the output segment contains the pattern `async () =>` not just `() =>`.
  </action>
  <verify>Test passes with `~/.cargo/bin/cargo test test_async_arrow --lib`</verify>
  <done>Async arrow function QRL test added and passing</done>
</task>

<task type="auto">
  <name>Task 2: Add test for async in useTask$ context</name>
  <files>optimizer/src/transform.rs</files>
  <action>
Add test `test_async_use_task` for async functions with useTask$:

Input:
```javascript
import { component$, useTask$ } from '@qwik.dev/core';

export const App = component$(() => {
  useTask$(async ({ track }) => {
    const result = await someAsyncOperation();
    return result;
  });
  return <div>App</div>;
});
```

Verify:
- The useTask$ callback segment preserves `async` keyword
- Parameter destructuring `{ track }` preserved
- await expressions work correctly

Reference SWC behavior: async flag on ArrowFunctionExpression should be preserved in segment output.
  </action>
  <verify>Test passes with `~/.cargo/bin/cargo test test_async_use_task --lib`</verify>
  <done>Async useTask$ test added and passing</done>
</task>

<task type="auto">
  <name>Task 3: Add test for async function expression in component$</name>
  <files>optimizer/src/transform.rs</files>
  <action>
Add test `test_async_function_expression` for async function expressions:

Input:
```javascript
import { $, component$ } from '@qwik.dev/core';

export const App = component$(async function() {
  await delay(100);
  return <div>Async Component</div>;
});

const handler = $(async function handleClick() {
  await doSomething();
});
```

Verify:
- Component segment preserves `async function()` syntax
- Named async function `handleClick` preserved as `async function handleClick()`
- Both function expression styles work

This tests both anonymous and named async function expressions in QRL context.
  </action>
  <verify>Test passes with `~/.cargo/bin/cargo test test_async_function --lib`</verify>
  <done>Async function expression test added and passing</done>
</task>

</tasks>

<verification>
1. `~/.cargo/bin/cargo check --lib` - No compilation errors
2. `~/.cargo/bin/cargo test --lib` - All tests pass
3. Async/await preserved in all QRL contexts
</verification>

<success_criteria>
- Async arrow functions preserve async keyword
- Async function expressions preserve async keyword
- await expressions work in QRL segments
- All three async tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/10-edge-cases/10-04-SUMMARY.md`
</output>
