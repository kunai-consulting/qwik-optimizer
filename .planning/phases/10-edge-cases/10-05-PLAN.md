---
phase: 10-edge-cases
plan: 05
type: execute
wave: 2
depends_on: ["10-01", "10-02", "10-03", "10-04"]
files_modified:
  - optimizer/src/transform.rs
autonomous: true

must_haves:
  truths:
    - "All 6 issue regression tests pass with correct output"
    - "Ternary expressions in class objects work (issue_150)"
    - "JSX without transpile preserves JSX syntax (issue_476)"
    - "Map with function expression works (issue_5008)"
  artifacts:
    - path: "optimizer/src/transform.rs"
      provides: "Issue regression test coverage"
  key_links:
    - from: "regression tests"
      to: "SWC snapshots"
      via: "output parity validation"
---

<objective>
Add regression tests for documented Qwik issues to ensure parity with SWC.

Purpose: These 6 issues represent real-world edge cases that users encountered. Tests ensure the OXC implementation handles them correctly.

Output: All 6 issue regression tests pass with output matching SWC snapshots.
</objective>

<execution_context>
@/Users/jackshelton/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jackshelton/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-edge-cases/10-RESEARCH.md
@optimizer/src/transform.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add issue_150 test (ternary in class object)</name>
  <files>optimizer/src/transform.rs</files>
  <action>
Add test `test_issue_150_ternary_class_object` for ternary expressions in class attributes:

Input (from issue_150.snap):
```javascript
import { component$, $ } from '@qwik.dev/core';
import { hola } from 'sdfds';

export const Greeter = component$(() => {
  const stuff = useStore();
  return $(() => {
    return (
      <div
        class={{
          'foo': true,
          'bar': stuff.condition,
          'baz': hola ? 'true' : 'false',
        }}
      />
    )
  });
});

const d = $(()=>console.log('thing'));
```

Verify:
- Ternary expression `hola ? 'true' : 'false'` preserved in output
- Class object with dynamic keys works correctly
- `stuff.condition` captured via useLexicalScope
- External import `hola` included in segment imports
- Both QRLs (Greeter and d) extracted correctly

This tests complex class attribute expressions.
  </action>
  <verify>Test passes with `~/.cargo/bin/cargo test test_issue_150 --lib`</verify>
  <done>Issue 150 regression test added and passing</done>
</task>

<task type="auto">
  <name>Task 2: Add issue_476 test (JSX without transpile) and issue_5008 test (map with function)</name>
  <files>optimizer/src/transform.rs</files>
  <action>
Add two tests:

1. `test_issue_476_jsx_without_transpile`:
Input (from issue_476.snap):
```javascript
import { Counter } from "./counter.tsx";

export const Root = () => {
  return (
    <html>
      <head>
        <meta charset="utf-8" />
        <title>Qwik Blank App</title>
      </head>
      <body>
        <Counter initial={3} />
      </body>
    </html>
  );
};
```

Use `transpile_jsx: false` in TransformOptions.
Verify:
- JSX preserved as-is in output (not converted to _jsxSorted)
- No QRL extraction (no $ markers)
- Component imports preserved

2. `test_issue_5008_map_with_function_expression`:
Input (from issue_5008.snap):
```javascript
import { component$, useStore } from "@qwik.dev/core";

export default component$(() => {
  const store = useStore([{ value: 0 }]);
  return (
    <>
      <button onClick$={() => store[0].value++}>+1</button>
      {store.map(function (v, idx) {
        return <div key={"fn_" + idx}>Function: {v.value}</div>;
      })}
      {store.map((v, idx) => (
        <div key={"arrow_" + idx}>Arrow: {v.value}</div>
      ))}
    </>
  );
});
```

Verify:
- Both function expression `function (v, idx)` and arrow `(v, idx) =>` map callbacks work
- v.value wrapped with _wrapProp (from Phase 4 work)
- Key expressions work correctly
- Fragment handling correct
  </action>
  <verify>Tests pass with `~/.cargo/bin/cargo test test_issue_476 --lib && ~/.cargo/bin/cargo test test_issue_5008 --lib`</verify>
  <done>Issue 476 and 5008 regression tests added and passing</done>
</task>

<task type="auto">
  <name>Task 3: Add issue_7216 test (spread props with event handlers)</name>
  <files>optimizer/src/transform.rs</files>
  <action>
Add test `test_issue_7216_spread_props_with_handlers`:

Input (from issue_7216_add_test.snap):
```javascript
import { component$ } from '@builder.io/qwik';
export default component$((props) => {
  return (<p
    onHi$={() => 'hi'}
    {...props.foo}
    onHello$={props.helloHandler$}
    {...props.rest}
    onVar$={props.onVarHandler$}
    onConst$={() => 'const'}
    asd={"1"}
  />);
});
```

Verify:
- Event handlers before spread go to var props
- Event handlers after spread go to const props
- _jsxSplit used (not _jsxSorted) because of interleaved spreads and handlers
- Props passed through correctly
- Both onHi$ and onConst$ QRLs extracted
- Props handlers (onHello$, onVar$) preserved as prop access

Note: This tests the complex interaction between spread props and event handlers. The _jsxSplit helper is used when spreads are interleaved with other props.
  </action>
  <verify>Test passes with `~/.cargo/bin/cargo test test_issue_7216 --lib`</verify>
  <done>Issue 7216 regression test added and passing</done>
</task>

</tasks>

<verification>
1. `~/.cargo/bin/cargo check --lib` - No compilation errors
2. `~/.cargo/bin/cargo test --lib` - All tests pass
3. All 6 issue regression tests validate correct behavior
</verification>

<success_criteria>
- All 6 issue regression tests implemented (117, 150, 476, 964, 5008, 7216)
- Each test validates specific edge case behavior
- Output matches SWC reference snapshots
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/10-edge-cases/10-05-SUMMARY.md`
</output>
