---
phase: 12-code-reduction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - optimizer/src/transform/generator.rs
  - optimizer/src/transform/jsx/element.rs
  - optimizer/src/transform/jsx/attribute.rs
  - optimizer/src/transform/jsx/child.rs
  - optimizer/src/transform/jsx/fragment.rs
  - optimizer/src/transform/qrl.rs
  - optimizer/src/transform/scope.rs
autonomous: true

must_haves:
  truths:
    - "No DEBUG constant exists in the codebase"
    - "No println! statements exist in transform modules"
    - "All verbose None::<OxcBox<TSTypeParameterInstantiation>> replaced with NONE"
    - "All Span::default() replaced with SPAN constant"
    - "Deeply nested functions use early returns for guard conditions"
    - "All 239 tests still pass"
  artifacts:
    - path: "optimizer/src/transform/generator.rs"
      provides: "Core transformer without debug code, using OXC conveniences"
      contains: "use oxc_ast::{.*NONE"
  key_links:
    - from: "generator.rs"
      to: "NONE constant"
      via: "import from oxc_ast"
      pattern: "use oxc_ast::.*NONE"
    - from: "generator.rs"
      to: "SPAN constant"
      via: "import from oxc_span"
      pattern: "use oxc_span::SPAN"
---

<objective>
Remove all debug code, adopt OXC convenience APIs, and add early returns to simplify control flow.

Purpose: Reduce code volume by ~170 lines through debug removal, API adoption, and control flow simplification.
Output: Cleaner production code with no debug output, using OXC conveniences, with simplified control flow.
</objective>

<execution_context>
@/Users/jackshelton/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jackshelton/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-code-reduction/12-RESEARCH.md
@optimizer/src/transform/generator.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove DEBUG constant and all debug output</name>
  <files>
    optimizer/src/transform/generator.rs
    optimizer/src/transform/jsx/element.rs
    optimizer/src/transform/jsx/attribute.rs
    optimizer/src/transform/jsx/child.rs
  </files>
  <action>
Remove all debug-related code from transform modules:

1. In generator.rs:
   - Remove `const DEBUG: bool = true;` line
   - Remove `const DUMP_FINAL_AST: bool = false;` if present
   - Remove all `if DEBUG { ... }` blocks entirely (not just the condition)
   - Remove all standalone `println!("...")` statements including:
     - `println!("ENTERING PROGRAM ...")`
     - `println!("EXITING PROGRAM ...")`
     - `println!("push segment: ...")`
     - `println!("pop segment: ...")`
     - `println!("Replacing expression...")`
     - `println!("Skip transform...")`
     - `println!("Registered prop...")`
     - `println!("Exited .map()...")`
   - Remove the DUMP_FINAL_AST conditional block entirely

2. In jsx/element.rs:
   - Remove `println!("push segment: ...")` statement

3. In jsx/attribute.rs:
   - Remove `println!("Replacing JSX attribute...")` statements

4. In jsx/child.rs:
   - Remove `println!("Replacing JSX child...")` statements

Do NOT remove:
- Any actual functionality
- Error handling that uses eprintln!
- Logging that might be used in production
  </action>
  <verify>
Run: `grep -r "println!" optimizer/src/transform/ | grep -v "eprintln" | wc -l`
Should return 0 (no println! statements remain).
Run: `grep -r "const DEBUG" optimizer/src/transform/`
Should return nothing.
  </verify>
  <done>No DEBUG constant, no println! statements in transform modules.</done>
</task>

<task type="auto">
  <name>Task 2: Adopt OXC convenience APIs (NONE, SPAN, builder.vec)</name>
  <files>
    optimizer/src/transform/generator.rs
    optimizer/src/transform/jsx/element.rs
    optimizer/src/transform/jsx/attribute.rs
    optimizer/src/transform/jsx/fragment.rs
    optimizer/src/transform/qrl.rs
    optimizer/src/transform/scope.rs
  </files>
  <action>
Adopt OXC convenience APIs across all transform modules:

1. Replace verbose `None::<OxcBox<TSTypeParameterInstantiation<'a>>>` with `NONE`:
   - Ensure NONE is imported: `use oxc_ast::NONE;` (already in generator.rs line 19)
   - Pattern: `None::<OxcBox<TSTypeParameterInstantiation<'a>>>` -> `NONE`
   - Pattern: `None::<OxcBox<TSTypeParameterDeclaration<'a>>>` -> `NONE`
   - Check jsx/ modules for NONE import - add if needed
   - Estimated ~20 replacements

2. Replace `Span::default()` with `SPAN` constant:
   - Ensure SPAN is imported: `use oxc_span::SPAN;`
   - Pattern: `Span::default()` -> `SPAN`
   - Estimated ~10 replacements

3. Verify and adopt builder.vec() usage:
   - Check for `OxcVec::new_in(allocator)` patterns
   - Replace with `builder.vec()` where appropriate
   - Estimated ~10 replacements

4. Verify vec1/vec_from_array usage:
   - These are already used correctly per RESEARCH.md
   - Just verify no manual single-item vector creation remains

Each replacement makes lines shorter while maintaining identical functionality.
  </action>
  <verify>
Run: `grep -r "None::<OxcBox<TSType" optimizer/src/transform/`
Should return nothing (all replaced with NONE).
Run: `grep -r "Span::default()" optimizer/src/transform/`
Should return nothing (all replaced with SPAN).
Run: `cargo test --package qwik-optimizer` - all 239 tests pass.
  </verify>
  <done>All OXC convenience APIs adopted: NONE, SPAN, builder.vec() where applicable.</done>
</task>

<task type="auto">
  <name>Task 3: Add early returns to deeply nested functions</name>
  <files>
    optimizer/src/transform/generator.rs
    optimizer/src/transform/jsx/element.rs
    optimizer/src/transform/jsx/attribute.rs
  </files>
  <action>
Add early returns to simplify control flow in deeply nested functions as documented in RESEARCH.md Pattern 1:

1. In generator.rs - `enter_call_expression` and `exit_call_expression`:
   - Identify guard conditions that, if false, mean no work is needed
   - Move these checks to the top with early returns
   - Reduce nesting depth from 4+ levels to 2-3

2. In jsx/element.rs - `exit_jsx_element`:
   - Has nested `if let` patterns
   - Add early returns for common skip conditions
   - Example: If no transformation needed, return early

3. In jsx/attribute.rs - `exit_jsx_attribute` (490 lines, very deep nesting):
   - This is the largest target for early return improvement
   - Identify the main guard conditions at the top
   - Replace nested `if let Some(x) = y { if let Some(z) = w { ... } }` with:
     ```rust
     let Some(x) = y else { return; };
     let Some(z) = w else { return; };
     // ... flattened code
     ```
   - Target reducing nesting from 5+ levels to 3 or fewer

Pattern to follow:
```rust
// BEFORE (deeply nested)
fn process(node: &mut Node) {
    if condition_a {
        if let Some(x) = get_x(node) {
            if let Some(y) = get_y(x) {
                // actual work
            }
        }
    }
}

// AFTER (early returns)
fn process(node: &mut Node) {
    if !condition_a {
        return;
    }
    let Some(x) = get_x(node) else { return; };
    let Some(y) = get_y(x) else { return; };
    // actual work (flattened)
}
```

Do NOT:
- Change any actual logic or behavior
- Break existing functionality
- Add early returns that change semantics (code after return must not be needed)
  </action>
  <verify>
Run: `cargo test --package qwik-optimizer` - all 239 tests pass.
Visually verify reduced nesting in the three target functions.
  </verify>
  <done>Deeply nested functions use early returns, reducing nesting depth while preserving behavior.</done>
</task>

</tasks>

<verification>
1. `grep -r "DEBUG\|println!" optimizer/src/transform/ | grep -v eprintln` returns empty
2. `grep -r "None::<OxcBox<TSType" optimizer/src/transform/` returns empty
3. `grep -r "Span::default()" optimizer/src/transform/` returns empty
4. `cargo test --package qwik-optimizer` passes all 239 tests
5. Code compiles without warnings
6. Nesting depth reduced in target functions
</verification>

<success_criteria>
- Zero println! statements in transform modules
- Zero DEBUG constant references
- All None::<OxcBox<TSType...>> replaced with NONE
- All Span::default() replaced with SPAN
- Early returns added to generator.rs, jsx/element.rs, jsx/attribute.rs
- All 239 tests pass
- ~170 lines reduced from transform modules
</success_criteria>

<output>
After completion, create `.planning/phases/12-code-reduction/12-01-SUMMARY.md`
</output>
